
# knitr document van Steensel lab

# Differential LAD gene expression and SuRE
## Christ Leemans, 03-11-2016 - to date

## Introduction
We would like to explore the effect of LADs on gene expression. When comparing Joris' SuRE data which explorers promoter activity outside of the dna-context (like lamina assosiation) and GroCAP data which explorers promoter activity in the context, one can define 3 groups of promoter in LADs: repressed, inactive and non repressed. The inactive promoters show no activity in both groCAP and SuRE data, the repressed show activity only in SuRE data, the non repressed group show activity in groCAP data as well as SuRE data. By comparing gene expression in different cell types with different lamina organisation, we should be able to show that indeed, the expression of the repressed group is most heavily influenced by lamina interaction, while the non-repressed group is not affected.


## Data
For now let's use data from public sources. If this shows prommising results we need to obtain gene expression data ourselves.

**HT1080**
Jop Kind also has data on this, but I could not find a complete control sample (m6ATracer-GFP-/DamLaminB1-, Doxycycline -/ Shield -)

GEO-ID: GSE60630

Description:
    G quadruplex motifs are frequently located near TSS and in the first introns of transcribed genes. We investigated the role that G4 structures play in transcription by stabilizing G4 DNA with the selective G4 ligand PhenDC3 in the HT-1080 human fibrosarcoma cell line. After treatment of triplicate samples with PhenDC3 or a negative control (DMSO carrier only), we performed RNA-Seq after poly-dT selection to assess changes in gene and isoform expression, as well as changes to splicing patterns.

Design:
    6 samples total; 2 gene expression conditions (treated and untreated) in triplicate; 4 raw sequencing files per sample

lab:
    Tasic, Allen Institute for Brain Science

```

zcat HT1080_ctrl_rep1_GSM1483942_SRR1555752.fastq HT1080_ctrl_rep1_GSM1483942_SRR1555753.fastq | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "HT1080_ctrl_rep1_GSM1483942_1.fastq"
        print substr($0,half+1) > "HT1080_ctrl_rep1_GSM1483942_2.fastq"
    } else {
        print $0 > "HT1080_ctrl_rep1_GSM1483942_1.fastq"
        print $0 > "HT1080_ctrl_rep1_GSM1483942_2.fastq"
    }}'

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _GSM1483942_STARtmp \
              --outFileNamePrefix HT1080_ctrl_rep1_GSM1483942 \
              --runThreadN 5 \
              --alignEndsProtrude 0 DiscordantPaiR --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn HT1080_ctrl_rep1_GSM1483942_1.fastq HT1080_ctrl_rep1_GSM1483942_2.fastq
rm HT1080_ctrl_rep1_GSM1483942_1.fastq HT1080_ctrl_rep1_GSM1483942_2.fastq

zcat HT1080_ctrl_rep2_GSM1483943_SRR1555754.fastq.gz HT1080_ctrl_rep2_GSM1483943_SRR1555755.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "HT1080_ctrl_rep2_GSM1483943_1.fastq"
        print substr($0,half+1) > "HT1080_ctrl_rep2_GSM1483943_2.fastq"
    } else {
        print $0 > "HT1080_ctrl_rep2_GSM1483943_1.fastq"
        print $0 > "HT1080_ctrl_rep2_GSM1483943_2.fastq"
    }}'

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _GSM1483943_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --outFileNamePrefix HT1080_ctrl_rep2_GSM1483943  \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn HT1080_ctrl_rep2_GSM1483943_1.fastq HT1080_ctrl_rep2_GSM1483943_2.fastq
rm HT1080_ctrl_rep2_GSM1483943_1.fastq HT1080_ctrl_rep2_GSM1483943_2.fastq

zcat HT1080_ctrl_rep3_GSM1483944_SRR1555756.fastq.gz HT1080_ctrl_rep3_GSM1483944_SRR1555757.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "HT1080_ctrl_rep3_GSM1483944_1.fastq"
        print substr($0,half+1) > "HT1080_ctrl_rep3_GSM1483944_2.fastq"
    } else {
        print $0 > "HT1080_ctrl_rep3_GSM1483944_1.fastq"
        print $0 > "HT1080_ctrl_rep3_GSM1483944_2.fastq"
    }}'

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _GSM1483944_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --outFileNamePrefix HT1080_ctrl_rep3_GSM1483944  \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn HT1080_ctrl_rep3_GSM1483944_1.fastq HT1080_ctrl_rep3_GSM1483944_2.fastq
rm HT1080_ctrl_rep3_GSM1483944_1.fastq HT1080_ctrl_rep3_GSM1483944_2.fastq

```

**K562**

This is the same data as Caroline used. The hESC data is from the same lab, so we have to keep in mind this effect.

GEO-ID: GSE86660

ENCODE-ID: ENCSR000CPH

Description:
    The libraries contained in this experiment come from the whole cell fraction of independent growths of cell line K562. They are stranded PE76 Illumina GAIIx RNA-Seq libraries from rRNA-depleted Poly-A+ RNA > 200 nucleotides in size.

Lab:
    Thomas Gingeras, CSHL


``` 

gunzip K562_rep1_ENCFF000HFF.fastq.gz K562_rep1_ENCFF000HFG.fastq.gz
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _K562_rep1_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --outFileNamePrefix K562_rep1 \
              --readFilesIn K562_rep1_ENCFF000HFF.fastq K562_rep1_ENCFF000HFG.fastq
gzip K562_rep1_ENCFF000HFF.fastq K562_rep1_ENCFF000HFG.fastq


gunzip K562_rep2_ENCFF000HFH.fastq.gz K562_rep2_ENCFF000HFY.fastq.gz
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _K562_rep2_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --outFileNamePrefix K562_rep2 \
              --readFilesIn K562_rep2_ENCFF000HFH.fastq K562_rep2_ENCFF000HFY.fastq
gzip K562_rep2_ENCFF000HFH.fastq K562_rep2_ENCFF000HFY.fastq

```

**hESC**

This is the same data as Caroline used. The K562 data is from the same lab, so we have to keep in mind this effect. Another thing to keep in mind is that this is a different cell line from the one in which we did Dam-ID. This was done in SHEF-2 ES-cells. Unfortunately I can't find any data on that cell-type.

GEO-ID: GSE78651

ENCODE-ID: ENCSR490SQH

Description:
    The libraries contained in this experiment come from independent growths of uninduced embryonic stem cell line H7-hESC. They are stranded PE101 Illumina Hi-Seq RNA-Seq libraries from rRNA-depleted Total RNA > 200 nucleotides in size.

Lab:
    Thomas Gingeras, CSHL
```

gunzip H7_hESC_rep1_ENCFF002DMP.fastq.gz H7_hESC_rep1_ENCFF002DMQ.fastq.gz
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H7_hESC_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --outFileNamePrefix H7_hESC_rep1 \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H7_hESC_rep1_ENCFF002DMP.fastq H7_hESC_rep1_ENCFF002DMQ.fastq
gzip H7_hESC_rep1_ENCFF002DMP.fastq H7_hESC_rep1_ENCFF002DMQ.fastq

gunzip H7_hESC_rep2_ENCFF002DMJ.fastq.gz H7_hESC_rep2_ENCFF002DMK.fastq.gz
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H7_hESC_rep2_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --outFileNamePrefix H7_hESC_rep2 \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H7_hESC_rep2_ENCFF002DMJ.fastq H7_hESC_rep2_ENCFF002DMK.fastq
gzip H7_hESC_rep2_ENCFF002DMJ.fastq H7_hESC_rep2_ENCFF002DMK.fastq


```

**Jurkat**

GEO-ID: GSE72300

Description:
    treatment: Vehicle (DMSO)
    Treatment protocol  Vehicle (DMSO) added to medium for 72h
    Growth protocol     RPMI 1640 supplemented with 10% FBS and 100 U/ml penicillin and 100 mg/ml streptomycin

Lab:
    Cellular and Molecular Medicine, Bioinformatics, OGIC
``` 
zcat J4_ctrl_rep1_GSM1859767_SRR2180201.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "J4_ctrl_rep1_GSM1859767_1.fastq"
        print substr($0,half+1) > "J4_ctrl_rep1_GSM1859767_2.fastq"
    } else {
        print $0 > "J4_ctrl_rep1_GSM1859767_1.fastq"
        print $0 > "J4_ctrl_rep1_GSM1859767_2.fastq"
    }}'

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _J4_rep1_STARtmp \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --outFileNamePrefix J4_ctrl_rep1 \
              --readFilesIn J4_ctrl_rep1_GSM1859767_1.fastq J4_ctrl_rep1_GSM1859767_2.fastq
rm J4_ctrl_rep1_GSM1859767_1.fastq J4_ctrl_rep1_GSM1859767_2.fastq

zcat J4_ctrl_rep2_GSM1859768_SRR2180202.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "J4_ctrl_rep2_GSM1859768_1.fastq"
        print substr($0,half+1) > "J4_ctrl_rep2_GSM1859768_2.fastq"
    } else {
        print $0 > "J4_ctrl_rep2_GSM1859768_1.fastq"
        print $0 > "J4_ctrl_rep2_GSM1859768_2.fastq"
    }}'

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _J4_ctrl_rep2_GSM1859768 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --outFileNamePrefix J4_ctrl_rep2 \
              --readFilesIn J4_ctrl_rep2_GSM1859768_1.fastq J4_ctrl_rep2_GSM1859768_2.fastq
rm J4_ctrl_rep2_GSM1859768_1.fastq J4_ctrl_rep2_GSM1859768_2.fastq

```

**SupT1**

GEO-ID:GSE38006

Summary:
    We sequenced the total mRNA from infected cells and detected differences in the expression of both host mRNA. We detected a small but significant suppression of T cell activation-related genes at 12 hpi. This suppression persisted and expanded by 24 hpi providing new possible markers of virus-induced T cell cytopathology. By 24 hpi the expression of over 50% of detectable host loci was also altered indicating widespread alteration of host processes including RNA processing, splicing, and transport to an extent not previously reported. In addition next-generation sequencing provided insights into the expression of non-coding RNAs including microRNA host genes.

Overal Design:
    We isolated polyadenylated RNA from SUPT1 cells infected with HIV-1 strain LAI at 12 and 24 hours post-infection (3 replicates for each time point). As controls we isolated polyadenylated RNA from mock-infected cells at 12 and 24 hours post-infection (2 replicates at 12 hours post-infection, 3 replicates at 24 hours post-infection).

Lab:
    Katze, University of Washington

```
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _SupT1_Mock_12hr_rep1 \
              --outFileNamePrefix SupT1_Mock_12hr_rep1 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesCommand zcat \
              --readFilesIn SupT1_Mock_12hr_rep1_GSM931771_SRR497705.fastq.gz 

 
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _SupT1_Mock_12hr_rep2 \
              --outFileNamePrefix SupT1_Mock_12hr_rep2 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesCommand zcat \
              --readFilesIn SupT1_Mock_12hr_rep2_GSM931772_SRR497706.fastq.gz 

 
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _SupT1_Mock_12hr_rep3 \
              --outFileNamePrefix SupT1_Mock_12hr_rep3 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesCommand zcat \
              --readFilesIn SupT1_Mock_12hr_rep3_GSM931773_SRR497707.fastq.gz

 
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _SupT1_Mock_24hr_rep1_SRR497709 \
              --outFileNamePrefix SupT1_Mock_24hr_rep1_SRR497709 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn SupT1_Mock_24hr_rep1_SRR497709.fastq.gz


```


**RPE**
GEO-ID: GSE36695

Design:
    RNA sequencing of hfRPE from three fetuses (reference sample) and three independent isolates of RPE derived from the H1, and three from the H9, human embryonic stem cell (hESC) lines. The cultures were maintained in a serum-free medium, SFM-1. Comparisons were also made to cultures maintained in the medium used to differentiate the cells, KSR.
lab:
    Genomics Core, Stem Cell Center, Yale University

```
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H1RPE.sfm.022311_GSM898968 \
              --outFileNamePrefix H1RPE.sfm.022311_GSM898968 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H1RPE.sfm.022311_GSM898968_SRR447139.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H1RPE.sfm.042011_GSM898969 \
              --outFileNamePrefix H1RPE.sfm.042011_GSM898969 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H1RPE.sfm.042011_GSM898969_SRR447140.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H1RPE.sfm.051311_GSM898970 \
              --outFileNamePrefix H1RPE.sfm.051311_GSM898970 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H1RPE.sfm.051311_GSM898970_SRR447141.fastq.gz


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H9RPE.sfm.041511_GSM898971 \
              --outFileNamePrefix H9RPE.sfm.041511_GSM898971 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H9RPE.sfm.041511_GSM898971_SRR447142.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H9RPE.sfm.042011_GSM898972 \
              --outFileNamePrefix H9RPE.sfm.042011_GSM898972 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H9RPE.sfm.042011_GSM898972_SRR447143.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _H9RPE.sfm.060311_GSM898973 \
              --outFileNamePrefix H9RPE.sfm.060311_GSM898973 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn H9RPE.sfm.060311_GSM898973_SRR447144.fastq.gz


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _hfRPESeq012611_GSM898967 \
              --outFileNamePrefix hfRPESeq012611_GSM898967 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn hfRPESeq012611_GSM898967_SRR447138.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _hfRPESeq072611_GSM1099813 \
              --outFileNamePrefix hfRPESeq072611_GSM1099813 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn hfRPESeq072611_GSM1099813_SRR786439.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _hfRPESeq090910_GSM898966 \
              --outFileNamePrefix hfRPESeq090910_GSM898966 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn hfRPESeq090910_GSM898966_SRR447137.fastq.gz

```

**T1-DS / T2-DS**

GEO-ID: GSE55504

Overall design:
    mRNA-Seq profiling in Down syndrome: fibroblasts derived from a pair of monozygotic twins discordant for trisomy 21 (4 replicates), iPS cells from the same pair of discordant twins, fibroblasts from a pair of normal monozygotic twins, fibroblasts from 16 unrelated individuals (8 trisomic and 8 euploid controls), fibroblasts from the Ts65Dn mouse model of Down syndrome (1 trisomic mouse and 1 control wt).

Lab:
    Antonarakis, Genetic Medicine and Development, University of Geneva Medical School

```

zcat T1DS_rep0_GSM1338311_SRR1182244.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T1DS_rep0_GSM1338311_1.fastq"
        print substr($0,half+1) > "T1DS_rep0_GSM1338311_2.fastq"
    } else {
        print $0 > "T1DS_rep0_GSM1338311_1.fastq"
        print $0 > "T1DS_rep0_GSM1338311_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T1DS_rep0_GSM1338311 \
              --outFileNamePrefix T1DS_rep0_GSM1338311 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T1DS_rep0_GSM1338311_1.fastq T1DS_rep0_GSM1338311_2.fastq
rm T1DS_rep0_GSM1338311_1.fastq T1DS_rep0_GSM1338311_2.fastq


zcat T1DS_rep1_GSM1338313_SRR1182246.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T1DS_rep1_GSM1338313_1.fastq"
        print substr($0,half+1) > "T1DS_rep1_GSM1338313_2.fastq"
    } else {
        print $0 > "T1DS_rep1_GSM1338313_1.fastq"
        print $0 > "T1DS_rep1_GSM1338313_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T1DS_rep1_GSM1338313 \
              --outFileNamePrefix T1DS_rep1_GSM1338313 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T1DS_rep1_GSM1338313_1.fastq T1DS_rep1_GSM1338313_2.fastq
rm T1DS_rep1_GSM1338313_1.fastq T1DS_rep1_GSM1338313_2.fastq


zcat T1DS_rep2_GSM1338315_SRR1182248.fastq T1DS_rep2_GSM1338315_SRR1182249.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T1DS_rep2_GSM1338315_1.fastq"
        print substr($0,half+1) > "T1DS_rep2_GSM1338315_2.fastq"
    } else {
        print $0 > "T1DS_rep2_GSM1338315_1.fastq"
        print $0 > "T1DS_rep2_GSM1338315_2.fastq"
    }}'



nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T1DS_rep2_GSM1338315 \
              --outFileNamePrefix T1DS_rep2_GSM1338315 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T1DS_rep2_GSM1338315_1.fastq T1DS_rep2_GSM1338315_2.fastq
rm T1DS_rep2_GSM1338315_1.fastq T1DS_rep2_GSM1338315_2.fastq


zcat T1DS_rep3_GSM1338317_SRR1182252.fastq T1DS_rep3_GSM1338317_SRR1182253.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T1DS_rep3_GSM1338317_1.fastq"
        print substr($0,half+1) > "T1DS_rep3_GSM1338317_2.fastq"
    } else {
        print $0 > "T1DS_rep3_GSM1338317_1.fastq"
        print $0 > "T1DS_rep3_GSM1338317_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T1DS_rep3_GSM1338317 \
              --outFileNamePrefix T1DS_rep3_GSM1338317 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T1DS_rep3_GSM1338317_1.fastq T1DS_rep3_GSM1338317_2.fastq
rm T1DS_rep3_GSM1338317_1.fastq T1DS_rep3_GSM1338317_2.fastq


zcat T2DS_rep0_GSM1338312_SRR1182245.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T2DS_rep0_GSM1338312_1.fastq"
        print substr($0,half+1) > "T2DS_rep0_GSM1338312_2.fastq"
    } else {
        print $0 > "T2DS_rep0_GSM1338312_1.fastq"
        print $0 > "T2DS_rep0_GSM1338312_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T2DS_rep0_GSM1338312 \
              --outFileNamePrefix T2DS_rep0_GSM1338312 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T2DS_rep0_GSM1338312_1.fastq T2DS_rep0_GSM1338312_2.fastq
rm T2DS_rep0_GSM1338312_1.fastq T2DS_rep0_GSM1338312_2.fastq


zcat T2DS_rep1_GSM1338314_SRR1182247.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T2DS_rep1_GSM1338314_1.fastq"
        print substr($0,half+1) > "T2DS_rep1_GSM1338314_2.fastq"
    } else {
        print $0 > "T2DS_rep1_GSM1338314_1.fastq"
        print $0 > "T2DS_rep1_GSM1338314_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T2DS_rep1_GSM1338314 \
              --outFileNamePrefix T2DS_rep1_GSM1338314 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T2DS_rep1_GSM1338314_1.fastq T2DS_rep1_GSM1338314_2.fastq
rm T2DS_rep1_GSM1338314_1.fastq T2DS_rep1_GSM1338314_2.fastq


zcat T2DS_rep2_GSM1338316_SRR1182250.fastq T2DS_rep2_GSM1338316_SRR1182251.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T2DS_rep2_GSM1338316_1.fastq"
        print substr($0,half+1) > "T2DS_rep2_GSM1338316_2.fastq"
    } else {
        print $0 > "T2DS_rep2_GSM1338316_1.fastq"
        print $0 > "T2DS_rep2_GSM1338316_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T2DS_rep2_GSM1338316 \
              --outFileNamePrefix T2DS_rep2_GSM1338316 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T2DS_rep2_GSM1338316_1.fastq T2DS_rep2_GSM1338316_2.fastq
rm T2DS_rep2_GSM1338316_1.fastq T2DS_rep2_GSM1338316_2.fastq


zcat T2DS_rep3_GSM1338318_SRR1182254.fastq T2DS_rep3_GSM1338318_SRR1182255.fastq.gz | \
awk '{
    if (NR%4==2 || NR%4==0){
        half=length($0)/2
        print substr($0,0,half) > "T2DS_rep3_GSM1338318_1.fastq"
        print substr($0,half+1) > "T2DS_rep3_GSM1338318_2.fastq"
    } else {
        print $0 > "T2DS_rep3_GSM1338318_1.fastq"
        print $0 > "T2DS_rep3_GSM1338318_2.fastq"
    }}'


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _T2DS_rep3_GSM1338318 \
              --outFileNamePrefix T2DS_rep3_GSM1338318 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn T2DS_rep3_GSM1338318_1.fastq T2DS_rep3_GSM1338318_2.fastq
rm T2DS_rep3_GSM1338318_1.fastq T2DS_rep3_GSM1338318_2.fastq


```
**KBM7**
GEO-ID: GSE47428

Overall design:
    Strand specific RNA-Seq of ribosomal RNA depleted total cellular RNA to measure transcript abundance and to detect fusion transcripts in KBM7 cells at standard culture conditions.

lab:
    Barlow, CeMM

```
nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _KBM7_bio_rep1_tech_rep1 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --outFileNamePrefix KBM7_bio_rep1_tech_rep1 \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn KBM7_bio_rep1_tech_rep1_GSM1149312_SRR867811.fastq.gz


nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _KBM7_bio_rep1_tech_rep2 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --outFileNamePrefix KBM7_bio_rep1_tech_rep2 \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn KBM7_bio_rep1_tech_rep2_GSM1149313_SRR867812.fastq.gz

nice -19 STAR --runMode alignReads \
              --sjdbGTFfile ~/data/GRCh37/Homo_sapiens.GRCh37.85.gtf \
              --quantMode GeneCounts \
              --outFilterIntronMotifs RemoveNoncanonical \
              --outTmpDir _KBM7_bio_rep2_tech_rep1 \
              --runThreadN 5 \
              --outSAMtype BAM Unsorted \
              --readFilesCommand zcat \
              --outFileNamePrefix KBM7_bio_rep2_tech_rep1 \
              --genomeDir ~/data/GRCh37/GenomeDir/ \
              --readFilesIn KBM7_bio_rep2_tech_rep1_GSM1149314_SRR867813.fastq.gz


```


## prepare biomaRt tables
```r
library(biomaRt)

file_list = list.files('../raw_data/expression', pattern='ReadsPerGene', full.names=T)

count_table = read.table(file_list[1], stringsAsFactors=F, row.names=1)
colnames(count_table) = c('unstranded', 'sense', 'antisense')

ENSG = grep('ENSG', rownames(count_table), value=T)
humanMart = useMart(biomart = 'ensembl', dataset = 'hsapiens_gene_ensembl')
bm_ens_gene = getBM(attributes=c('ensembl_gene_id', 'ensembl_transcript_id', 
                                 'transcript_length', 'percentage_gc_content', 'transcription_start_site'),
                    filters='ensembl_gene_id', values=ENSG, mart=humanMart)

load('../raw_data/gencode.sure.160617.rda')

ensembl_transcript_id = do.call(rbind, strsplit(gencode.sure.160617$name, split='[.]'))[,1]


bm_p<-getBM(attributes = c("ensembl_gene_id", "ensembl_transcript_id", "chromosome_name", "start_position", "end_position", "strand", 'transcription_start_site'),
           filters = "ensembl_transcript_id", values = ensembl_transcript_id, mart = humanMart)

save(bm_ens_gene, bm_p, file='../raw_data/biomart.rdata')
```


## library, parameters and stuff
```{r, fig.width=10, fig.height=10}
library(reshape2)
library(rtracklayer)
library(DESeq2)
library(ggplot2)
library(gridExtra)
library(biomaRt)
library(plyr)
library(preprocessCore)
library(aroma.light)
load('../raw_data/biomart.rdata')

file_list = list.files('../raw_data/expression', pattern='ReadsPerGene', full.names=T)

sample_id_list = lapply(file_list, function(x){
                        file = strsplit(x,'/')[[1]][4]
                        return(gsub('ReadsPerGene.out.tab', '', file))
                        })
count_list = lapply(file_list, function(x){
                count_table = read.table(x, stringsAsFactors=F)
                colnames(count_table) = c('name', 'unstranded', 'sense', 'antisense')
                return(count_table)
            })
names(count_list) = unlist(sample_id_list)


## since there are different machines, they might have different GC biases
## for GC bias we have to use hg19 genome
gff_ranges = import.gff('../../../data/GRCh37/Homo_sapiens.GRCh37.85.gff3')
## let's focus on genes located on actual chromosomes
gff_ranges = gff_ranges[seqnames(gff_ranges) %in% seqlevels(gff_ranges)[1:25]]
seqlevels(gff_ranges) = paste0('chr',seqlevels(gff_ranges)[1:25])
seqlevels(gff_ranges)[25] = 'chrM'

ens_gene_ranges = gff_ranges[gff_ranges$gene_id %in% count_list[[1]][,1]]




```
##stats

```{r, fig.width=10, fig.height=50}
stat_list = lapply(names(count_list), function(x){
        count = count_list[[x]]
        N_mapped = colSums(count[5:nrow(count), 2:4])
        numbers = rbind(count[1:4,2:4], N_mapped)
        ratios = t(t(numbers)/colSums(numbers))
        stat = cbind.data.frame(name=c(count[1:4,1], 'N_mapped'), ratios, sample_id=x)
        return(melt(stat, id.vars=c('name', 'sample_id')))
    })
stat = do.call(rbind.data.frame, stat_list)
ggplot(do.call(rbind.data.frame, stat_list), aes(x=variable, y=as.numeric(value), fill=factor(name))) + geom_bar(stat='identity', position='dodge', ) + facet_wrap( ~ sample_id, ncol=3)

```
**conclusion:**

Let's not use KBM7, after some inspection fo the data and looking at the description of the gene set at GEO, I don't want to spent more effort trying to include this dataset. It seems like some datasets are stranded, while others contain unstranded DNA reads both in forward and reverse orientation.


## normalization

```{r, fig.width=20, fig.height=20}


colData = DataFrame(cell_type=c(rep('ESC', 2), rep('RPE',3), rep("HT1080", 3),
                                rep("Jurkat", 2), rep('K562', 2), rep('SupT1', 3)),
                    row.names=c('H7_hESC_rep1', 'H7_hESC_rep2',
                                'hfRPESeq012611_GSM898967', 'hfRPESeq090910_GSM898966', 
                                'hfRPESeq072611_GSM1099813',
                                'HT1080_ctrl_rep1_GSM1483942',
                                'HT1080_ctrl_rep2_GSM1483943',
                                'HT1080_ctrl_rep3_GSM1483944', 'J4_ctrl_rep1',
                                'J4_ctrl_rep2', 'K562_rep1', 'K562_rep2',
                                'SupT1_Mock_12hr_rep1', 'SupT1_Mock_12hr_rep2',
                                'SupT1_Mock_12hr_rep3'))

unstranded_list = lapply(count_list,function(x){
        count = x[5:nrow(x),2]
        names(count) = x[5:nrow(x), 1]
        return(count)
    })
count_table = do.call(cbind, unstranded_list)
colnames(count_table) = names(count_list)
count_table = count_table[,-grep('KBM7', names(count_list))]

## without quantile normalization
exp = SummarizedExperiment(assays=list(counts=count_table[, rownames(colData)]), rowRanges=ens_gene_ranges, colData=colData)
dds_direct = DESeqDataSet(exp, design = ~ cell_type)
dds_direct = DESeq(dds_direct)
fpm_direct = fpm(dds_direct)
fpm_direct = fpm_direct + min(fpm_direct[fpm_direct!=0])/2
ggplot(melt(fpm_direct), aes(x=log10(value), color=Var2)) + geom_density(adjust=1/2) + ggtitle('fpm values\nwithout quantile normalization')

```

**conclusion:**

Fpm normalization seems to work well.




## SuRE data

First we need the SuRE data, this has filtered gencode data with annotated promoter positions. Let's also annotate the different groups of promoters in LADs as defined in "Promoter_SuRE_in_LADs_exploration_BvS161031.html".

```{r, fig.width=10, fig.height=10}
load("../raw_data/gencode.sure.160617.rda")
Prom<-gencode.sure.160617; rm(gencode.sure.160617) #simpler name
#first re-calculate pseudocounts without jitter
P<-Prom[,c(1:8,23,20,26,28)] #SuRE, GRO-cap, CAGE and LAD columns only
names(P)[9:12]<-c("SuRE", "GROcap", "CAGE", "LAD")
Pseud<-min(P$SuRE[P$SuRE>0], na.rm=TRUE)/2
P$SuRE<-P$SuRE+Pseud
P$SuRE<-log10(P$SuRE)
PseudGro<-min(P$GROcap[P$GROcap>0], na.rm=TRUE)/2
P$GROcap<-P$GROcap+PseudGro
P$GROcap<-log10(P$GROcap)

#then calculate running mean for iLAD promoters:
P<-P[order(P$SuRE,sample(c(1:nrow(P)))),] #sort by SuRE and then random for ties
n<-60 #number of windows
w<-501 #window width (number of datapoints); if n*w > nrow(P) then windows overlap
s<-round(seq(from=w/2+0.0001, to=nrow(P)-w/2, length.out=n))
RM<-data.frame(SuRE.low=rep(NA,n), SuRE.mean=rep(NA,n), SuRE.hi=rep(NA,n), GROcap.lad=rep(NA,n), GROcap.ilad=rep(NA,n))
RM$SuRE.low=P$SuRE[s-floor(w/2)]
for(i in 1:n){RM$SuRE.mean[i]=mean(P$SuRE[(s[i]-floor(w/2)):(s[i]+floor(w/2))], na.rm=TRUE)}
RM$SuRE.hi=P$SuRE[s+floor(w/2)]
for(i in 1:n)
  {t<-P[(s[i]-floor(w/2)):(s[i]+floor(w/2)),]
   RM$GROcap.lad[i]<-mean(t$GROcap[t$LAD==1], na.rm=TRUE)
   RM$GROcap.ilad[i]<-mean(t$GROcap[t$LAD==0], na.rm=TRUE)
  }
#add first datapoint (SuRE equals pseudocount)
RM1<-RM[0,] #empty df
RM1[1,]<-c(rep(log10(Pseud),3), mean(P$GROcap[P$SuRE==log10(Pseud) & P$LAD==1]), mean(P$GROcap[P$SuRE==log10(Pseud) & P$LAD==0]))
RM<-rbind(RM1, RM)
rm(RM1)

#finally calculate LRS for all promoters:
P$LRS<- P$GROcap - approx(x=RM$SuRE.mean, y=RM$GROcap.ilad, xout=P$SuRE, rule=2)$y
#so the more negative the score, the more 'repressed' is the promoter by its chromatin/LAD context


#(arbitrary) cutoffs to define three groups of promoters:
INACT<- P$SuRE< -0.3 & P$LAD==1 & P$GROcap< -2 #inactive
NREP<- P$SuRE>0 & P$LRS> 0 & P$LAD==1 #not repressed
REP<- P$SuRE>0.3 & P$LRS< -1 & P$LAD==1  & P$GROcap< -2 #repressed
Pcnts<-c(length(which(REP)), length(which(NREP)), length(which(INACT)))
names(Pcnts)<-c("repressed", "not_repressed", "inactive")


#add class annotation column to P:
P$class<-NA
P$class[P$LAD==0]<-"iLAD"
P$class[INACT]<-"inactive"
P$class[NREP]<-"not_repressed"
P$class[REP]<-"repressed"

COLi<-"#00BBFF11" #dot color for iLAD promoters
#color vector for plotting:
COL<-c("#A020F0", "#FFA500", "#006400")
names(COL)<-c("repressed", "not_repressed", "inactive")
p_classes = P[P$class %in% c('inactive', 'not_repressed', 'repressed'),]
ggplot(P, aes(x=SuRE, y=GROcap)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=p_classes,size=0.6, color=COL[p_classes$class])

```


## link promoter SuRE data to gene expression
```{r, fig.width=10, fig.height=10}
P$ensembl_transcript_id = do.call(rbind, strsplit(P$name, split='[.]'))[,1]

P<-merge(P, bm_p, by="ensembl_transcript_id", all.x=TRUE)
nrow(P) #number of unique promoters

length(unique(P$ensembl_gene_id)) #number of unique genes

table(P[,c('strand.x','strand.y')]) #almost all strand listings are consistent

P<-P[, colnames(P)!='strand.y']
colnames(P)[colnames(P)=='strand.x'] = "strand"

table(P$ensembl_gene_id %in% row.names(fpm_direct))
table(row.names(fpm_direct) %in% P$ensembl_gene_id)
table(P$ensembl_gene_id %in% row.names(count_table))
table(row.names(count_table) %in% P$ensembl_gene_id)


Ep<-merge(fpm_direct,unique(P[,c('ensembl_gene_id','chr','start_position','end_position', 'strand', 'tss')]), by.x='row.names', by.y="ensembl_gene_id")



loc_col = match(c('chr', 'start_position', 'end_position', 'Row.names'),
                colnames(Ep))
colnames(Ep)[loc_col] = c('seqnames', 'start', 'end', 'names')


```

## DamID data
```{r}
#DamID data:
load("../raw_data/CdG140714humanLmnb1wK562.rData") #Lamin B1 DamID data compiled by Carolyn de Graaf

lad_probe_raw = allHumanAvHg19[,c(6:9, 13, 16)]
lad_state = allHumanStateHg19[,c(6:9, 13, 16)]
colnames(lad_probe_raw) = colnames(lad_state) = c('ESC', 'HT1080', 'Jurkat', 'SupT1', 'RPE', 'K562')
ggplot(melt(lad_probe_raw), aes(x=value, color=variable)) + geom_density()


lad_probe_vnorm = data.frame(apply(lad_probe_raw,2,function(x){
    x = x - mean(x)
    x = x / var(x)
  }))

ggplot(melt(lad_probe_vnorm), aes(x=value, color=variable)) + geom_density()

lad_probe_qnorm = normalize.quantiles(as.matrix(lad_probe_raw))
lad_probe_qnorm = data.frame(lad_probe_qnorm)
dimnames(lad_probe_qnorm) = dimnames(lad_probe_raw)
ggplot(melt(lad_probe_qnorm), aes(x=value, color=variable)) + geom_density()

# convert everything to GenomicRanges objects:
Dgr<-makeGRangesFromDataFrame(allHumanAvHg19, starts.in.df.are.0based=TRUE) #same for tiling array DamID data
Egr <-makeGRangesFromDataFrame(Ep, keep.extra.columns=TRUE) #genes as Granges object


F_gene<-5000
Egr.t<-Egr
w<-width(Egr.t)<F_gene*2
GC<-as.integer((start(Egr.t[w])+end(Egr.t[w]))/2)
start(Egr.t[w])<-GC-F_gene
end(Egr.t[w])<-GC+F_gene

h<-findOverlaps(Egr.t, Dgr) #find sets of overlapping probes:

oENSG<-Egr.t[from(h)]$names

lad_list = lapply(unique(colData$cell_type), function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_raw[to(h),], oENSG)

DamIDbyGene_raw<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_raw) = unique(colData$cell_type)
ggplot(melt(DamIDbyGene_raw), aes(x=value, color=variable)) + geom_density()

lad_list = lapply(unique(colData$cell_type), function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_qnorm[to(h),], oENSG)

DamIDbyGene_qnorm<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_qnorm) = unique(colData$cell_type)
ggplot(melt(DamIDbyGene_qnorm), aes(x=value, color=variable)) + geom_density()


lad_list = lapply(unique(colData$cell_type), function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_vnorm[to(h),], oENSG)

DamIDbyGene_vnorm<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_vnorm) = unique(colData$cell_type)
ggplot(melt(DamIDbyGene_vnorm), aes(x=value, color=variable)) + geom_density()

```
**conclusion:**

let's discard the RPE cell line

```{r}
celltype_vec = unique(colData[colData$cell_type!='RPE',])

lad_probe_raw = allHumanAvHg19[,c(6:9, 16)]
lad_state = allHumanStateHg19[,c(6:9, 16)]
colnames(lad_probe_raw) = colnames(lad_state) = c('ESC', 'HT1080', 'Jurkat', 'SupT1', 'K562')


lad_probe_vnorm = data.frame(apply(lad_probe_raw,2,function(x){
    x = x - mean(x)
    x = x / var(x)
  }))


lad_probe_qnorm = normalize.quantiles(as.matrix(lad_probe_raw))
lad_probe_qnorm = data.frame(lad_probe_qnorm)
dimnames(lad_probe_qnorm) = dimnames(lad_probe_raw)

# convert everything to GenomicRanges objects:
Dgr<-makeGRangesFromDataFrame(allHumanAvHg19, starts.in.df.are.0based=TRUE) #same for tiling array DamID data
Egr <-makeGRangesFromDataFrame(Ep, keep.extra.columns=TRUE) #genes as Granges object


F_gene<-5000
Egr.t<-Egr
w<-width(Egr.t)<F_gene*2
GC<-as.integer((start(Egr.t[w])+end(Egr.t[w]))/2)
start(Egr.t[w])<-GC-F_gene
end(Egr.t[w])<-GC+F_gene

h<-findOverlaps(Egr.t, Dgr) #find sets of overlapping probes:

oENSG<-Egr.t[from(h)]$names

lad_list = lapply(celltype_vec, function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_raw[to(h),], oENSG)

DamIDbyGene_raw<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_raw) = celltype_vec
ggplot(melt(DamIDbyGene_raw), aes(x=value, color=variable)) + geom_density()


lad_list = lapply(celltype_vec, function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_qnorm[to(h),], oENSG)

DamIDbyGene_qnorm<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_qnorm) = celltype_vec
ggplot(melt(DamIDbyGene_qnorm), aes(x=value, color=variable)) + geom_density()

lad_list = lapply(celltype_vec, function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_probe_vnorm[to(h),], oENSG)

DamIDbyGene_vnorm<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_vnorm) = celltype_vec
ggplot(melt(DamIDbyGene_vnorm), aes(x=value, color=variable)) + geom_density()

lad_list = lapply(celltype_vec, function(x, oVAL, oENSG){
                    aggregate(oVAL[,x], by=list(oENSG), FUN=mean, na.rm=TRUE)$x
                }, lad_state[to(h),], oENSG)

DamIDbyGene_hmm<-data.frame(row.names=unique(oENSG), do.call(cbind, lad_list))
colnames(DamIDbyGene_hmm) = celltype_vec
```



## correlation between expression and LAD-status per cell type

```{r, fig.width=10, fig.height=10}

sampleCor_raw = lapply(rownames(colData[colData$cell_type%in%celltype_vec]), function(x){
                dam_signal = DamIDbyGene_raw[,colData[x,]]
                exp = log10(fpm_direct)[rownames(DamIDbyGene_raw),x]
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

sampleCor_raw = do.call(rbind, sampleCor_raw)
rownames(sampleCor_raw) = rownames(colData[colData$cell_type%in%celltype_vec])
colnames(sampleCor_raw) = c('cor','intercept','slope','Drange')

cellCor_raw = lapply(celltype_vec, function(x){
                dam_signal = DamIDbyGene_raw[,x]
                exp = rowMeans(log10(fpm_direct)[rownames(DamIDbyGene_raw),which(colData$cell_type==x)])
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

cellCor_raw = do.call(rbind, cellCor_raw)
rownames(cellCor_raw) = celltype_vec
colnames(cellCor_raw) = c('cor','intercept','slope','Drange')


## correlation using direct FPM values (with psuedocount)
kable(cellCor_raw, digits=3)
kable(sampleCor_raw, digits=3)

sampleCor_qnorm = lapply(rownames(colData[colData$cell_type%in%celltype_vec]), function(x){
                dam_signal = DamIDbyGene_qnorm[,colData[x,]]
                exp = log10(fpm_direct)[rownames(DamIDbyGene_qnorm),x]
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

sampleCor_qnorm = do.call(rbind, sampleCor_qnorm)
rownames(sampleCor_qnorm) = rownames(colData[colData$cell_type%in%celltype_vec])
colnames(sampleCor_qnorm) = c('cor','intercept','slope','Drange')

cellCor_qnorm = lapply(celltype_vec, function(x){
                dam_signal = DamIDbyGene_qnorm[,x]
                exp = rowMeans(log10(fpm_direct)[rownames(DamIDbyGene_qnorm),which(colData$cell_type==x)])
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

cellCor_qnorm = do.call(rbind, cellCor_qnorm)
rownames(cellCor_qnorm) = celltype_vec
colnames(cellCor_qnorm) = c('cor','intercept','slope','Drange')


## correlation using direct FPM values (with psuedocount)
kable(cellCor_qnorm, digits=3)
kable(sampleCor_qnorm, digits=3)


sampleCor_vnorm = lapply(rownames(colData[colData$cell_type%in%celltype_vec]), function(x){
                dam_signal = DamIDbyGene_vnorm[,colData[x,]]
                exp = log10(fpm_direct)[rownames(DamIDbyGene_vnorm),x]
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

sampleCor_vnorm = do.call(rbind, sampleCor_vnorm)
rownames(sampleCor_vnorm) = rownames(colData[colData$cell_type%in%celltype_vec])
colnames(sampleCor_vnorm) = c('cor','intercept','slope','Drange')

cellCor_vnorm = lapply(celltype_vec, function(x){
                dam_signal = DamIDbyGene_vnorm[,x]
                exp = rowMeans(log10(fpm_direct)[rownames(DamIDbyGene_vnorm),which(colData$cell_type==x)])
                c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
            })

cellCor_vnorm = do.call(rbind, cellCor_vnorm)
rownames(cellCor_vnorm) = celltype_vec
colnames(cellCor_vnorm) = c('cor','intercept','slope','Drange')


## correlation using direct FPM values (with psuedocount)
kable(cellCor_vnorm, digits=3)
kable(sampleCor_vnorm, digits=3)

```

**conclusion:**
Normalization doesn't seem to affect correlation within cell type and samples too much. Which is nice.





```{r, fig.width=10, fig.height=10}

plot_list=list()
for (gene in P_laura$ensembl_gene_id){
  dam_signal = as.numeric(DamIDbyGene_qnorm[gene,celltype_vec])
  exp = unlist(lapply(celltype_vec, function(y){
                  mean(log10(fpm_direct[gene,colData$cell_type==y]))
                }))
  plot_list[[gene]] = ggplot(cbind.data.frame(dam_signal, exp),
                             aes(x=dam_signal,y=exp)) + 
                        geom_point() +
                        stat_smooth(method = "lm", col = "red")
}
do.call(grid.arrange, plot_list)

DEcor_raw = lapply(rownames(DamIDbyGene_raw), function(x){
                dam_signal = as.numeric(DamIDbyGene_raw[x,celltype_vec])
                exp = unlist(lapply(celltype_vec, function(y){
                  mean(log10(fpm_direct[x,colData$cell_type==y]))
                }))
                suppressWarnings(
                  c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
                )
            })
DEcor_raw = do.call(rbind.data.frame, DEcor_raw)
colnames(DEcor_raw) = c('cor','intercept','slope','Drange')
rownames(DEcor_raw) = rownames(DamIDbyGene_raw)
#plot correlations and slopes:
ggplot(DEcor_raw, aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")


DRcut<-0.3 #cutoff for Drange (minimum dynamic range of DamID data)
table(DEcor_raw$Drange>DRcut) #how many drop out

DEcor_raw = merge(DEcor_raw, P, by.x='row.names', by.y='ensembl_gene_id')

ggplot(DEcor_raw[DEcor_raw$Drange>DRcut & DEcor_raw$slope!=0,], aes(x=cor, color=class))+ geom_density()

ggplot(DEcor_raw[DEcor_raw$Drange>DRcut & DEcor_raw$slope!=0,], aes(x=slope, color=class))+ geom_density()


ggplot(DEcor_raw, aes(x=cor, y=slope)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=DEcor_raw[DEcor_raw$class %in% c('inactive', 'not_repressed', 'repressed'),], aes(color=class), size=0.6)

# now let's try a different cutoff
ggplot(DEcor_raw, aes(x=Drange, color=class)) + geom_density() + geom_vline(xintercept=0.3) +geom_vline(xintercept=0.75)

DRcut<-0.75 #cutoff for Drange (minimum dynamic range of DamID data)
table(DEcor_raw$Drange>DRcut) #how many drop out

ggplot(DEcor_raw[DEcor_raw$Drange>DRcut,], aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")

ggplot(DEcor_raw[DEcor_raw$Drange>DRcut & DEcor_raw$slope!=0,], aes(x=cor, y=slope)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=DEcor_raw[DEcor_raw$Drange>DRcut & DEcor_raw$slope!=0 & DEcor_raw$class %in% c('inactive', 'not_repressed', 'repressed'),], aes(color=class), size=0.6) 

subset = DEcor_raw[DEcor_raw$Drange>DRcut & DEcor_raw$slope!=0,]
ggplot(subset, aes(x=cor, color=class))+ geom_density(adjust=1/2) + scale_color_manual(values=c(COL,iLAD='#00BBFF'))

ggplot(subset, aes(x=slope, color=class))+ geom_density(adjust=1/2) + scale_color_manual(values=c(COL,iLAD='#00BBFF'))

cat('\nratio of positive correlation in all samples:\n')
table(DEcor_raw$cor>0)
cat('\nratio of positive correlation with at least 0.3 dynamic range of probe intensity:\n')
table(DEcor_raw[DEcor_raw$Drange>0.3, 'cor']>0)
cat('\nratio of positive correlation with at least 0.75 dynamic range of probe intensity:\n')
table(DEcor_raw[DEcor_raw$Drange>0.75, 'cor']>0)


ggplot(melt(DamIDbyGene_qnorm), aes(x=value, color=variable)) + geom_density() + geom_vline(xintercept=0)

qnorm_gene_vec = rownames(DamIDbyGene_qnorm)[rowSums(DamIDbyGene_qnorm < 0)>=1 &
                                             rowSums(DamIDbyGene_qnorm > 0 )>=1 ]


qnorm_gene_vec = rownames(DamIDbyGene_qnorm)[rowSums(DamIDbyGene_hmm == 1)>=1 &
                                             rowSums(DamIDbyGene_hmm == 2 )>=1 ]

qnorm_gene_vec = rownames(DamIDbyGene_qnorm)

DEcor_qnorm = lapply(qnorm_gene_vec, function(x){
                dam_signal = as.numeric(DamIDbyGene_qnorm[x,celltype_vec])
                exp = unlist(lapply(celltype_vec, function(y){
                  mean(log10(fpm_direct[x,colData$cell_type==y]))
                }))
                suppressWarnings(
                  c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
                )
            })
DEcor_qnorm = do.call(rbind.data.frame, DEcor_qnorm)
colnames(DEcor_qnorm) = c('cor','intercept','slope','Drange')
rownames(DEcor_qnorm) = qnorm_gene_vec
#plot correlations and slopes:
ggplot(DEcor_qnorm, aes(x=cor, y=slope)) + geom_point(size=0.5, alpha=0.3) +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")

DEcor_qnorm = merge(DEcor_qnorm, P, by.x='row.names', by.y='ensembl_gene_id')


subset_cor = DEcor_qnorm[DEcor_qnorm$class %in% c('inactive', 'not_repressed', 'repressed'),]
ggplot(DEcor_qnorm, aes(x=cor, y=slope)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=subset_cor, size=0.6, color=COL[subset_cor$class]) 

p1 = ggplot(DEcor_qnorm, aes(x=cor, color=class))+ geom_density() + scale_color_manual(values=c(COL,iLAD='#00BBFF'))

p2 = ggplot(DEcor_qnorm, aes(x=slope, color=class))+ geom_density() + scale_color_manual(values=c(COL,iLAD='#00BBFF'))
grid.arrange(p1,p2,ncol=2)

ggplot(DEcor_qnorm[DEcor_qnorm$GROcap < -2, ], aes(x=SuRE, y=cor)) + geom_point()

DEcor_qnorm$cor_class = factor(ceiling(DEcor_qnorm$cor*2)/2)
cor_levels = levels(DEcor_qnorm$cor_class)
r = 2:(length(cor_levels)-1)
levels(DEcor_qnorm$cor_class)[r] = paste(cor_levels[r-1], '< cor <=', cor_levels[r])
levels(DEcor_qnorm$cor_class)[1] = paste('cor <=', cor_levels[1])
levels(DEcor_qnorm$cor_class)[length(cor_levels)] = paste('cor >', cor_levels[length(cor_levels) - 1])
         
ggplot(DEcor_qnorm[!is.na(DEcor_qnorm$cor_class) & DEcor_qnorm$class %in% c('repressed', 'inactive','not_repressed'),], aes(x=cor_class, fill=class))  + geom_bar(position='dodge')

class_count = table(DEcor_qnorm[,c('class', 'cor_class')])
class_percent = class_count/rowSums(class_count) * 100
class_label = paste('n=', class_count)

class_data = melt(class_percent)
class_data$label = class_label

ggplot(class_data, aes(x=cor_class, y=value, fill=class))  + geom_bar(position='dodge', stat='identity') + geom_text(aes(x=as.numeric(cor_class) + (as.numeric(class)-2.5)/4.5, label=class_label), nudge_y=1)


DRcut<-0.3 #cutoff for Drange (minimum dynamic range of DamID data)

class_count = table(DEcor_qnorm[DEcor_qnorm$Drange > DRcut,c('class', 'cor_class')])
class_percent = class_count/rowSums(class_count) * 100
class_label = paste('n=', class_count)

class_data = melt(class_percent)
class_data$label = class_label

ggplot(class_data, aes(x=cor_class, y=value, fill=class))  + geom_bar(position='dodge', stat='identity') + geom_text(aes(x=as.numeric(cor_class) + (as.numeric(class)-2.5)/4.5, label=class_label), nudge_y=1)


table(DEcor_qnorm$Drange>DRcut) #how many drop out

ggplot(DEcor_qnorm[DEcor_qnorm$Drange>DRcut,], aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")

ggplot(DEcor_qnorm[DEcor_qnorm$Drange>DRcut & DEcor_qnorm$slope!=0,], aes(x=cor, y=slope)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=DEcor_qnorm[DEcor_qnorm$Drange>DRcut & DEcor_qnorm$slope!=0 & DEcor_qnorm$class %in% c('inactive', 'not_repressed', 'repressed'),], aes(color=class), size=0.6) 

subset = DEcor_qnorm[DEcor_qnorm$Drange>DRcut & DEcor_qnorm$slope!=0,]
p1 = ggplot(subset, aes(x=cor, color=class))+ geom_density() + scale_color_manual(values=c(COL,iLAD='#00BBFF'))

p2 = ggplot(subset, aes(x=slope, color=class))+ geom_density() + scale_color_manual(values=c(COL,iLAD='#00BBFF'))
grid.arrange(p1,p2,ncol=2)

cat('\nratio of positive correlation in all samples:\n')
table(DEcor_qnorm$cor>0)
cat('\nratio of positive correlation with at least 1 dynamic range of probe intensity:\n')
table(DEcor_qnorm[DEcor_qnorm$Drange>DRcut, 'cor']>0)


DEcor_vnorm = lapply(rownames(DamIDbyGene_vnorm), function(x){
                dam_signal = as.numeric(DamIDbyGene_vnorm[x,colData$cell_type])
                exp = unlist(lapply(celltype_vec, function(y){
                  mean(log10(fpm_direct[x,colData$cell_type==y]))
                }))
                suppressWarnings(
                  c(cor(dam_signal, exp, use='p',
                      method='pearson'),
                  lm(exp ~ dam_signal)$coefficients,
                  diff(range(dam_signal, na.rm=TRUE)))
                )
            })
DEcor_vnorm = do.call(rbind.data.frame, DEcor_vnorm)
colnames(DEcor_vnorm) = c('cor','intercept','slope','Drange')
rownames(DEcor_vnorm) = rownames(DamIDbyGene_vnorm)
#plot correlations and slopes:
ggplot(DEcor_vnorm, aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")


DRcut<-1 #cutoff for Drange (minimum dynamic range of DamID data)
table(DEcor_vnorm$Drange>DRcut) #how many drop out

DEcor_vnorm = merge(DEcor_vnorm, P, by.x='row.names', by.y='ensembl_gene_id')


subset = DEcor_vnorm[DEcor_vnorm$Drange>DRcut & DEcor_vnorm$slope!=0,]
ggplot(subset, aes(x=cor, color=class))+ geom_density(adjust=1/2) + scale_color_manual(values=c(COL,iLAD='#00BBFF'))


subset = DEcor_vnorm[DEcor_vnorm$Drange>DRcut & DEcor_vnorm$slope!=0,]
ggplot(subset, aes(x=slope, color=class))+ geom_density(adjust=1/2) + scale_color_manual(values=c(COL,iLAD='#00BBFF'))


ggplot(DEcor_vnorm, aes(x=cor, y=slope)) + 
    geom_point(size=0.1,color=COLi) + 
    geom_point(data=DEcor_vnorm[DEcor_vnorm$class %in% c('inactive', 'not_repressed', 'repressed'),], aes(color=class), size=0.6)


cat('\nratio of positive correlation in all samples:\n')
table(DEcor_vnorm$cor>0)
cat('\nratio of positive correlation with at least 0.3 dynamic range of probe intensity:\n')
table(DEcor_vnorm[DEcor_vnorm$Drange>0.3, 'cor']>0)
cat('\nratio of positive correlation with at least 0.75 dynamic range of probe intensity:\n')
table(DEcor_vnorm[DEcor_vnorm$Drange>0.75, 'cor']>0)
```
**conclusion:**

Although the difference's between classes could be bigger, in general we can see the trends we would expect in the data. But a large part of the expression data shows a positive correlation between lamina interaction and expression. It would be interesting to see how the probe signal changes around these genes.




## lamina interaction around promoter

For our different cell types, how do the promoters from each of the different categories identified by comparing GROcap with SuRE? The different categories were identified in K562, but since I expect cell-specific genes that are repressed to be largely repressed in the other celltypes and the non repressed genes to also still be associated with the lamina since they are apparently not bothered by it, we should see the same dips in other cell lines as well.

```{r, fig.width=10, fig.height=10}
F_tss<-22000


Egr.p = Egr[width(Egr)>F_tss]
p_match = match(Egr.p$names, P$ensembl_gene_id)
P_start = P[p_match, 'tss'] - F_tss
P_start = ifelse(P_start<1,1,P_start)
P_end = P[p_match, 'tss'] + F_tss
ranges(Egr.p) = IRanges(P_start, P_end)

h<-findOverlaps(Egr.p, Dgr)
oENSG<-Egr.p[from(h)]$names
oPOS<-ifelse(strand(Egr.p[from(h)])=='+',
             (start(Dgr[to(h)])+end(Dgr[to(h)]))/2 - start(Egr.p[from(h)]) -F_tss,
             end(Egr.p[from(h)]) - (start(Dgr[to(h)])+end(Dgr[to(h)]))/2 -F_tss)

         #coordinates of all overlapping probes relative to the gene starts
oVAL<-lad_probe_vnorm[to(h),]


#plot:
par(mfrow=c(2,3))
for(celltype in celltype_vec)
 {for(i in names(COL)) #for the three gene classes
   {s<-unique(P$ensembl_gene_id[which(P$class==i)])
    s<-s[!is.na(s)]
    w<-oENSG %in% s #which rows in oENSG correspond to genes in s
    subPOS<-oPOS[w]
    subVAL<-oVAL[w, celltype]
    o<-order(subPOS) #need to order all values by distance to gene start for running median plot:
    subPOS<-subPOS[o]
    subVAL<-subVAL[o]
    #determine runmed k:
    wsize<-floor(length(subPOS)/25) #4% of all datapoints in the set
    if(!wsize %% 2) {wsize<-wsize+1} #must be odd
    #plot:
    plot(subPOS, subVAL, pch=".", col="#00000033", xlim=c(-F_tss,F_tss)*0.9,ylim=c(-2,4),
         main=paste(celltype, i, length(s), sep=" "), xlab="position relative to gene start (bp)", ylab="DamID logratio")
    lines(subPOS, runmed(subVAL, k=wsize), col=COL[i], lwd=2)
    abline(v=0, lty="dotted")
   }
 }

 oVAL<-lad_probe_qnorm[to(h),]
#plot:
par(mfrow=c(1,3))
for(celltype in celltype_vec)
 {for(i in names(COL)) #for the three gene classes
   {s<-unique(P$ensembl_gene_id[which(P$class==i)])
    s<-s[!is.na(s)]
    w<-oENSG %in% s #which rows in oENSG correspond to genes in s
    subPOS<-oPOS[w]
    subVAL<-oVAL[w, celltype]
    o<-order(subPOS) #need to order all values by distance to gene start for running median plot:
    subPOS<-subPOS[o]
    subVAL<-subVAL[o]
    #determine runmed k:
    wsize<-floor(length(subPOS)/50) #2% of all datapoints in the set
    if(!wsize %% 2) {wsize<-wsize+1} #must be odd
    #plot:
    plot(subPOS, subVAL, pch=".", col="#00000033", xlim=c(-F_tss,F_tss)*0.9, ylim=c(-1,2),
         main=paste(celltype, i, length(s), sep=" "), xlab="position relative to gene start (bp)", ylab="DamID logratio")
    lines(subPOS, runmed(subVAL, k=wsize), col=COL[i], lwd=2)
    abline(v=0, lty="dotted")
   }
 }
```
**conclusion:**
Most cell types show more or less the same differences, only the fibroblasts from the down syndrom twins is really different in this respect. Maybe there is a difference because these cells are prone to senescence.



```{r, fig.width=10, fig.height=10}

Dgr$lad_state = NA
Dgr$lad_state[rowSums(lad_state) == ncol(lad_state)] = 'iLAD'
Dgr$lad_state[rowSums(lad_state) == ncol(lad_state) * 2] = 'cLAD'
Dgr$lad_state[rowSums(lad_state) < ncol(lad_state) * 2 &
              rowSums(lad_state) > ncol(lad_state)] = 'fLAD'

F_gene<-5000
Egr.t<-Egr
gene_width<-width(Egr.t)<F_gene*2
GC<-as.integer((start(Egr.t[gene_width])+end(Egr.t[gene_width]))/2)
start(Egr.t[gene_width])<-GC-F_gene
end(Egr.t[gene_width])<-GC+F_gene

h<-findOverlaps(Egr.t, Dgr) #find sets of overlapping probes:

gene_vec = Egr.t[from(h)]$names
state_vec = Dgr[to(h)]$lad_state
lad_state_genes = lapply(unique(gene_vec), function(x){
    tab = table(state_vec[gene_vec==x])
    c(x, names(tab)[tab==max(tab)][1])
  })
lad_state_genes = do.call(rbind, lad_state_genes)
lad_state_genes = data.frame(row.names=lad_state_genes[,1],
                             lad_state=lad_state_genes[,2])



DamIDbyGene_rawLAD = DamIDbyGene_raw[lad_state_genes=='cLAD' | 
                                    lad_state_genes=='fLAD',]

DEcor_raw = lapply(rownames(DamIDbyGene_rawLAD), function(x){
                dam_signal = as.numeric(DamIDbyGene_rawLAD[x,colData$cell_type])
                exp = as.numeric(log10(fpm_direct[x,]))
                suppressWarnings(
                    c(cor(dam_signal, exp, use='p',
                        method='pearson'),
                    lm(exp ~ dam_signal)$coefficients,
                    diff(range(dam_signal, na.rm=TRUE)))
                  )
            })
DEcor_raw = do.call(rbind.data.frame, DEcor_raw)
colnames(DEcor_raw) = c('cor','intercept','slope','Drange')
rownames(DEcor_raw) = rownames(DamIDbyGene_rawLAD)
#plot correlations and slopes:
ggplot(DEcor_raw, aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")



table(DEcor_raw[DEcor_raw$Drange>1, 'cor']>0)
DEcor_raw$cor_group = NA
DEcor_raw[which(DEcor_raw$Drange>1 & DEcor_raw$cor > 0.5), 'cor_group'] = 'high_positive'
DEcor_raw[which(DEcor_raw$Drange>1 & DEcor_raw$cor <= 0.5 & DEcor_raw$cor > 0), 'cor_group'] = 'low_positive'
DEcor_raw[which(DEcor_raw$Drange>1 & DEcor_raw$cor <= 0 & DEcor_raw$cor > -0.5), 'cor_group'] = 'low_negative'
DEcor_raw[which(DEcor_raw$Drange>1 & DEcor_raw$cor <= -0.5), 'cor_group'] = 'high_negative'

par(mfrow=c(2,3))
for(i in c('high_negative', 'low_negative', 'low_positive', 'high_positive')) #for the three gene classes
{
  s<-rownames(DEcor_raw[which(DEcor_raw$cor_group==i), ])
  s = s[which(s %in% oENSG)]
  s_order = apply(DamIDbyGene_rawLAD[s,],1,function(x){names(x)[order(x)]})
  for (j in 1:6){
    w<-oENSG %in% s #which rows in oENSG correspond to genes in s
    subPOS<-oPOS[w]
    
    subVAL<-lapply(s,function(x){
        this_w = which(oENSG == x)
        cell_type = s_order[j,x]
        return(oVAL[this_w,cell_type])
      })
    subVAL = unlist(subVAL)
    o<-order(subPOS) #need to order all values by distance to gene start for running median plot:
    subPOS<-subPOS[o]
    subVAL<-subVAL[o]
    #determine runmed k:
    wsize<-floor(length(subPOS)/50) #2% of all datapoints in the set
    if(!wsize %% 2) {wsize<-wsize+1} #must be odd
    #plot:
    plot(subPOS, subVAL, pch=".", col="#00000033", xlim=c(-F_tss,F_tss)*0.9, ylim=c(-5,5),
         main=paste('order',j, '\n', i, length(s)), xlab="position relative to gene start (bp)", ylab="DamID logratio")
    lines(subPOS, runmed(subVAL, k=wsize), col='red', lwd=2)
    abline(v=0, lty="dotted")
  }
  
}


DamIDbyGene_qnormLAD = DamIDbyGene_qnorm[lad_state_genes=='cLAD' | 
                                    lad_state_genes=='fLAD',]

DEcor_qnorm = lapply(rownames(DamIDbyGene_qnormLAD), function(x){
                dam_signal = as.numeric(DamIDbyGene_qnormLAD[x,colData$cell_type])
                exp = as.numeric(log10(fpm_direct[x,]))
                suppressWarnings(
                    c(cor(dam_signal, exp, use='p',
                        method='pearson'),
                    lm(exp ~ dam_signal)$coefficients,
                    diff(range(dam_signal, na.rm=TRUE)))
                  )
            })
DEcor_qnorm = do.call(rbind.data.frame, DEcor_qnorm)
colnames(DEcor_qnorm) = c('cor','intercept','slope','Drange')
rownames(DEcor_qnorm) = rownames(DamIDbyGene_qnormLAD)
#plot correlations and slopes:
ggplot(DEcor_qnorm, aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")



table(DEcor_qnorm[DEcor_qnorm$Drange>1, 'cor']>0)
DEcor_qnorm$cor_group = NA
DEcor_qnorm[which(DEcor_qnorm$Drange>1 & DEcor_qnorm$cor > 0.5), 'cor_group'] = 'high_positive'
DEcor_qnorm[which(DEcor_qnorm$Drange>1 & DEcor_qnorm$cor <= 0.5 & DEcor_qnorm$cor > 0), 'cor_group'] = 'low_positive'
DEcor_qnorm[which(DEcor_qnorm$Drange>1 & DEcor_qnorm$cor <= 0 & DEcor_qnorm$cor > -0.5), 'cor_group'] = 'low_negative'
DEcor_qnorm[which(DEcor_qnorm$Drange>1 & DEcor_qnorm$cor <= -0.5), 'cor_group'] = 'high_negative'

par(mfrow=c(2,3))
for(i in c('high_negative', 'low_negative', 'low_positive', 'high_positive')) #for the three gene classes
{
  s<-rownames(DEcor_qnorm[which(DEcor_qnorm$cor_group==i), ])
  s = s[which(s %in% oENSG)]
  s_order = apply(DamIDbyGene_qnormLAD[s,],1,function(x){names(x)[order(x)]})
  for (j in 1:6){
    w<-oENSG %in% s #which rows in oENSG correspond to genes in s
    subPOS<-oPOS[w]
    
    subVAL<-lapply(s,function(x){
        this_w = which(oENSG == x)
        cell_type = s_order[j,x]
        return(lad_probe_qnorm[this_w,cell_type])
      })
    subVAL = unlist(subVAL)
    o<-order(subPOS) #need to order all values by distance to gene start for running median plot:
    subPOS<-subPOS[o]
    subVAL<-subVAL[o]
    #determine runmed k:
    wsize<-floor(length(subPOS)/50) #2% of all datapoints in the set
    if(!wsize %% 2) {wsize<-wsize+1} #must be odd
    #plot:
    plot(subPOS, as.numeric(subVAL), pch=".", col="#00000033", xlim=c(-F_tss,F_tss)*0.9,
         ylim=c(-5,5),
         main=paste('order',j, i, length(s), sep=" "), xlab="position relative to gene start (bp)", ylab="DamID logratio")
    lines(subPOS, runmed(subVAL, k=wsize), col='red', lwd=2)
    abline(v=0, lty="dotted")
  }
  
}

DamIDbyGene_vnormLAD = DamIDbyGene_vnorm[lad_state_genes=='cLAD' | 
                                    lad_state_genes=='fLAD',]

DEcor_vnorm = lapply(rownames(DamIDbyGene_vnormLAD), function(x){
                dam_signal = as.numeric(DamIDbyGene_vnormLAD[x,colData$cell_type])
                exp = as.numeric(log10(fpm_direct[x,]))
                suppressWarnings(
                    c(cor(dam_signal, exp, use='p',
                        method='pearson'),
                    lm(exp ~ dam_signal)$coefficients,
                    diff(range(dam_signal, na.rm=TRUE)))
                  )
            })
DEcor_vnorm = do.call(rbind.data.frame, DEcor_vnorm)
colnames(DEcor_vnorm) = c('cor','intercept','slope','Drange')
rownames(DEcor_vnorm) = rownames(DamIDbyGene_vnormLAD)
#plot correlations and slopes:
ggplot(DEcor_vnorm, aes(x=cor, y=slope)) + geom_point(size=0.5, col="#00000033") +
    xlab('Pearsom correlation') + ggtitle("distribution of correlations and slopes")



table(DEcor_vnorm[DEcor_vnorm$Drange>1, 'cor']>0)
DEcor_vnorm$cor_group = NA
DEcor_vnorm[which(DEcor_vnorm$Drange>1 & DEcor_vnorm$cor > 0.5), 'cor_group'] = 'high_positive'
DEcor_vnorm[which(DEcor_vnorm$Drange>1 & DEcor_vnorm$cor <= 0.5 & DEcor_vnorm$cor > 0), 'cor_group'] = 'low_positive'
DEcor_vnorm[which(DEcor_vnorm$Drange>1 & DEcor_vnorm$cor <= 0 & DEcor_vnorm$cor > -0.5), 'cor_group'] = 'low_negative'
DEcor_vnorm[which(DEcor_vnorm$Drange>1 & DEcor_vnorm$cor <= -0.5), 'cor_group'] = 'high_negative'

par(mfrow=c(2,3))
for(i in c('high_negative', 'low_negative', 'low_positive', 'high_positive')) #for the three gene classes
{
  s<-rownames(DEcor_vnorm[which(DEcor_vnorm$cor_group==i), ])
  s = s[which(s %in% oENSG)]
  s_order = apply(DamIDbyGene_vnormLAD[s,],1,function(x){names(x)[order(x)]})
  for (j in 1:6){
    w<-oENSG %in% s #which rows in oENSG correspond to genes in s
    subPOS<-oPOS[w]
    
    subVAL<-lapply(s,function(x){
        this_w = which(oENSG == x)
        cell_type = s_order[j,x]
        return(lad_probe_vnorm[this_w,cell_type])
      })
    subVAL = do.call(cbind, subVAL)
    o<-order(subPOS) #need to order all values by distance to gene start for running median plot:
    subPOS<-subPOS[o]
    subVAL<-subVAL[o]
    #determine runmed k:
    wsize<-floor(length(subPOS)/50) #2% of all datapoints in the set
    if(!wsize %% 2) {wsize<-wsize+1} #must be odd
    #plot:
    plot(subPOS, subVAL, pch=".", col="#00000033", xlim=c(-F_tss,F_tss)*0.9, ylim=c(-2,2),
         main=paste('order',j, i, length(s), sep=" "), xlab="position relative to gene start (bp)", ylab="DamID logratio") 
    lines(subPOS, runmed(subVAL, k=wsize), col='red', lwd=2)
    abline(v=0, lty="dotted")
  }
  
}
```


```{r, fig.width=10, fig.height=10}
mean_K = rowMeans(fpm_direct[,c('K562_rep1', 'K562_rep2')])
names(mean_K) = rownames(count_table)


expression = mean_K[P$ensembl_gene_id]
P$expression = log10(expression + min(expression[which(expression>0)])/3)

plot(P$SuRE, P$expression, xlab="log10(SuRE)", ylab="log10(expression)", pch=19, cex=0.1, col=COLi)
points(P$SuRE[INACT], P$expression[INACT], pch=19, cex=0.6, col=COL["inactive"])
points(P$SuRE[NREP], P$expression[NREP], pch=19, cex=0.6, col=COL["not_repressed"])
points(P$SuRE[REP], P$expression[REP], pch=19, cex=0.6, col=COL["repressed"])
legend("topleft", legend=c("iLAD prom", paste("LAD prom ", names(COL), " n=", Pcnts, sep="")), col=c(COLi,COL), pch=19)

COLi<-"#00BBFF11" #dot color for iLAD promoters
plot(P$GROcap, P$expression, xlab="log10(GROcap)", ylab="log10(expression)", pch=19, cex=0.1, col=COLi)
points(P$GROcap[INACT], P$expression[INACT], pch=19, cex=0.6, col=COL["inactive"])
points(P$GROcap[NREP], P$expression[NREP], pch=19, cex=0.6, col=COL["not_repressed"])
points(P$GROcap[REP], P$expression[REP], pch=19, cex=0.6, col=COL["repressed"])
legend("topleft", legend=c("iLAD prom", paste("LAD prom ", names(COL), " n=", Pcnts, sep="")), col=c(COLi,COL), pch=19)

```
**conclusion:**

It seems like the gene expression data does not correlate well with GROcap. Maybe it's because genes might be expressed from different TSS's.


